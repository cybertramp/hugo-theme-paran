{{ define "main" }}
  <div class="search-container">
    <h1>ğŸ” Search</h1>
    <div class="search-box">
      <input type="text" id="search-input" placeholder="Enter search keyword" autocomplete="off" />
      <button id="search-button">Search</button>
    </div>
    <div id="result-count"></div>
    <div class="split-line"></div>
    <div id="search-results"></div>
  </div>

  <script id="search-index" type="application/json">
    {{- $pages := where site.Pages "Kind" "page" -}}
    {{- $index := slice -}}
    {{- range $pages -}}
      {{- $index = $index | append (dict "title" .Title "permalink" .RelPermalink "content" (.Plain | htmlUnescape) "summary" .Summary "date" (.Date.Format "2006-01-02") "tags" .Params.tags "categories" .Params.categories) -}}
    {{- end -}}
    {{- $index | jsonify -}}
    </script>
  <script src="/fuse.min.js" onload="console.log('fuse.min.js loaded')" onerror="console.error('fuse.min.js load failed')"></script>
  <script>
    console.log("Search system loaded");

    try {
      // 1. JSON ìš”ì†Œ ì¡´ì¬ í™•ì¸
      const jsonElement = document.getElementById("search-index");
      if (!jsonElement) {
        throw new Error("Search index element not found. Please check if script#search-index exists in HTML.");
      }

      // 2. JSON ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
      const rawText = jsonElement.textContent.trim();
      console.log("Raw JSON Text:", rawText.substring(0, 100) + (rawText.length > 100 ? "..." : ""));

      if (!rawText) {
        throw new Error("ê²€ìƒ‰ ì¸ë±ìŠ¤ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. Hugoê°€ JSONì„ ìƒì„±í•˜ì§€ ëª»í•œ ê²ƒ ê°™ìŠµë‹ˆë‹¤.");
      }

      let rawData;
      try {
        const parsed = JSON.parse(rawText);
        // íŒŒì‹± ê²°ê³¼ê°€ ë¬¸ìì—´ì´ë©´ ë‹¤ì‹œ JSON.parse ì‹œë„
        rawData = typeof parsed === "string" ? JSON.parse(parsed) : parsed;
      } catch (e) {
        console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", e);
        throw new Error("ê²€ìƒ‰ ì¸ë±ìŠ¤ JSON í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤: " + e.message);
      }

      // 3. ë°ì´í„° êµ¬ì¡° ê²€ì¦
      console.log("JSON ë°ì´í„° êµ¬ì¡°:", rawData);
      if (rawData === null || rawData === undefined) {
        throw new Error("Invalid data structure. Data is null or undefined.");
      }

      // ë°°ì—´ì´ ì•„ë‹Œ ê²½ìš° ë°°ì—´ë¡œ ë³€í™˜
      let normalizedData = rawData;
      if (!Array.isArray(rawData)) {
        if (rawData && typeof rawData === "object") {
          normalizedData = Object.values(rawData);
        } else {
          throw new Error(`Invalid data structure. (type: ${typeof rawData})`);
        }
      }

      // 4. ë°ì´í„° ì •ê·œí™” (ë” ì—„ê²©í•œ í•„í„°ë§)
      const searchData = normalizedData
        .filter((item) => item && (item.title || item.content) && typeof item === "object")
        .map((item, index) => ({
          title: item.title || `[No title-${index}]`,
          content: item.content || "",
          permalink: item.permalink || "#",
          summary: item.summary || "",
          date: item.date || "",
          tags: Array.isArray(item.tags) ? item.tags : [],
          categories: Array.isArray(item.categories) ? item.categories : [],
        }));

      console.log("Total valid search items:", searchData.length);
      if (searchData.length === 0) {
        throw new Error("No valid search data to process");
      }

      // 5. Fuse.js ì´ˆê¸°í™”
      const fuse = new Fuse(searchData, {
        keys: [
          { name: "title", weight: 0.5 },
          { name: "content", weight: 0.4 },
          { name: "tags", weight: 0.1 },
        ],
        includeMatches: true,
        threshold: 0.3,
        ignoreLocation: false, // ì •í™•í•œ ìœ„ì¹˜ ë§¤ì¹­
        minMatchCharLength: 3, // ìµœì†Œ 3ê¸€ì ì´ìƒ
        tokenize: true,
        matchAllTokens: true,
        findAllMatches: false, // ì „ì²´ ë§¤ì¹­ ë¹„í™œì„±í™”
        shouldSort: true,
      });

      // ì´ˆê¸° í™”ë©´ - ì „ì²´ í¬ìŠ¤íŠ¸ ìˆ˜ë§Œ í‘œì‹œ
      document.getElementById("result-count").textContent = `Total ${searchData.length}ea posts`;

      function renderResults(results) {
        const resultsDiv = document.getElementById("search-results");
        const resultCount = document.getElementById("result-count");

        if (!results.length) {
          resultsDiv.innerHTML = "<p>Not found matched results</p>";
          resultCount.textContent = "0ea results";
          return;
        }

        resultCount.textContent = `${results.length}ea results`;
        resultsDiv.innerHTML = `<div class="list-items">${results
          .map(
            (result) => `
            <a href="${result.item.permalink}" class="list-item-link">
              <div class="list-item text-muted">
                <div class="post-items-header">
                  <h2 class="post-title">${result.item.title}</h2>
                  <div class="post-meta-line">
                    ${result.item.categories && result.item.categories.length > 0 ? `<span class="post-category">ğŸ“ ${result.item.categories[0]}</span>` : ''}
                    <span class="post-date">${result.item.date}</span>
                  </div>
                </div>
                <div class="post-summary">
                  ${getHighlightedSnippet(result)}
                </div>
              </div>
            </a>`,
          )
          .join("")}</div>`;
      }

      function getHighlightedSnippet(result) {
        // ë‹¨ì–´ ë‹¨ìœ„ ë§¤ì¹­ ê°•ì¡°
        const contentMatch = result.matches?.find((m) => m.key === "content");
        if (!contentMatch) return result.item.content.substring(0, 100) + "...";

        const { value, indices } = contentMatch;
        let highlighted = "";
        let lastIndex = 0;

        indices.forEach(([start, end]) => {
          highlighted += value.substring(lastIndex, start);
          highlighted += `<mark>${value.substring(start, end + 1)}</mark>`;
          lastIndex = end + 1;
        });

        highlighted += value.substring(lastIndex);
        return highlighted.substring(0, 150) + (highlighted.length > 150 ? "..." : "");
      }

      // 7. ì´ˆê¸° ì „ì²´ ëª©ë¡ í‘œì‹œ
      // renderResults(searchData.map(item => ({ item, score: 0, matches: [] })));

      // 8. ì‹¤ì‹œê°„ ê²€ìƒ‰ í•¸ë“¤ëŸ¬
      document.getElementById("search-input").addEventListener("input", (e) => {
        const query = e.target.value.trim();
        if (query.length < 3) {
          document.getElementById("result-count").textContent = `Total ${searchData.length}ea posts`;
          document.getElementById("search-results").innerHTML = "<p>Please enter at least 3 characters</p>";
          return;
        }

        const results = fuse.search(query);
        renderResults(results);
      });
    } catch (error) {
      console.error("Search system initialization failed - detailed error:", error);
      document.getElementById("search-results").innerHTML = `<div class="search-error">
          <p>Search functionality load failed: ${error.message}</p>
          <p>Please check the detailed error in the console.</p>
        </div>`;
    }
  </script>
{{ end }}
